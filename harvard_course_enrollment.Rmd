---
title: "Harvard Course Enrollment"
author: "Dasha Metropolitansky"
date: "April 9, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(janitor)
library(fs)

download.file(url = "https://registrar.fas.harvard.edu/files/fas-registrar/files/class_enrollment_summary_by_term_3.22.19.xlsx",
              destfile = "reg_2019.xlsx",
              mode = "wb")

download.file(url = "https://registrar.fas.harvard.edu/files/fas-registrar/files/class_enrollment_summary_by_term_03.06.18.xlsx",
              destfile = "reg_2018.xlsx",
              mode = "wb")

spring_2019 = read_excel("reg_2019.xlsx", skip = 3) %>% 
  clean_names() %>%
  filter(!is.na(course_name)) %>%
  select(course_id, u_grad, course_department)
  
spring_2018 = read_excel("reg_2018.xlsx", skip = 3) %>% 
  clean_names() %>%
  filter(!is.na(course_name)) %>%
  select(course_id, u_grad, course_department)

file_delete(c("reg_2018.xlsx", "reg_2019.xlsx")) 
```

```{r include = FALSE}
x = spring_2019 %>%
  left_join(spring_2018, by = "course_id") %>%
  filter(course_department.x == course_department.y) %>%
  select(-course_department.y) %>%
  rename(course_department = course_department.x,
         u_grad_2019 = u_grad.x, 
         u_grad_2018 = u_grad.y) %>%
  mutate(course_department = recode_factor(course_department,
                                           `African & African Amer Studies` = "African Studies",
                                           `Classics, The` = "Classics",
                                           `Celtic Languages & Literatures` = "Celtic Languages",
                                           `East Asian Langs & Civ` = "East Asian Languages",
                                           `Envi Science & Public Policy` = "Environmental Science",
                                           `Germanic Languages & Lit` = "Germanic Languages",
                                           `Near Eastern Languages & Civ` = "Near Eastern Languages",
                                           `Organismic & Evolutionary Biol` = "Organismic & Evolutionary Biology",
                                           `Religion, The Study of` = "Religion",
                                           `Romance Languages & Lit` = "Romance Languages",
                                           `Slavic Languages & Literatures` = "Slavic Languages",
                                           `Stem Cell & Regenerative Biol` = "Regenerative Biology")) %>%
  group_by(course_department) %>%
  summarise(department_total_19 = sum(u_grad_2019),
            department_total_18 = sum(u_grad_2018)) %>%
  filter(!(department_total_19 <50 | department_total_18 <50)) %>%
  mutate(percent_change = round(((department_total_19 - department_total_18)/department_total_18 * 100), digits = 0)) %>%
  arrange(desc(percent_change))

x_top = x %>%
  slice(1:8)

x_bottom = x %>%
  slice(tail(row_number(), 8))

y = rbind(x_top, x_bottom)
  
```

```{r echo = FALSE}
y %>%
  ggplot(aes(x = reorder(course_department, percent_change), y = percent_change, fill = department_total_19)) +
  geom_col() +
  geom_hline(yintercept = 0, colour = "black", size = 0.5) +
  geom_vline(xintercept = 8.5, colour = "black", linetype = "dotted") +
  geom_rect(aes(xmin = 8.5, xmax = 16.5, ymin = -Inf, ymax = Inf), alpha = 0.015, fill = "steelblue2") +
  geom_rect(aes(xmin = 0, xmax = 8.5, ymin = -Inf, ymax = Inf), alpha = 0.015, fill = "dodgerblue4") +
  labs(y = "Percent Change in Course Enrollment",
       x = "Department",
       caption = "\n *Departments where a total of 50+ students took its courses in Spring 2018 & 2019
       \n **The total number of students enrolled in all courses offered by the department in Spring 2019
       \n Data from the Harvard Registrar",
       title = "Changing Popularity of Harvard Courses by Department",
       subtitle = "Undergraduate enrollment in Spring 2018 vs. Spring 2019*") +
  coord_flip() + 
  ylim(-60, 60) +
  theme_minimal() +
  guides(fill = guide_legend(title= "Department Size**")) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 15, b = 0, l = 0))) +
  theme(axis.title.x = element_text(margin = margin(t = 15, r = 0, b = 0, l = 0))) +
  theme(plot.title = element_text(face="bold", margin = margin(t = 0, r = 0, b = 8, l = 0))) +
  theme(plot.subtitle = element_text(margin = margin(t = 0, r = 0, b = 8, l = 0)))
```

